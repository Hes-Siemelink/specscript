Input parameters:
  db:
    description: The SQLite database
    default: db/tickets.db

SQLite:
  file: ${db}
  update:
    - |
      -- Compact backlog_order so it becomes a dense 1..N sequence without gaps
      WITH ordered AS (
        SELECT id, ROW_NUMBER() OVER (ORDER BY backlog_order) AS rn
        FROM ticket
        ORDER BY backlog_order
      )
      UPDATE ticket
      SET backlog_order = (
        SELECT rn FROM ordered WHERE ordered.id = ticket.id
      );
  query: |
    SELECT COUNT(*) AS tickets_reordered FROM ticket;
Output:
  message: "Backlog reordered and compacted (no gaps)."

